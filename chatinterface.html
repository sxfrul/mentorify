<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Mentorify</title>
    <link rel="stylesheet" href="mentorify.css">
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-profile-section">
                <img class="chat-profile-icon" src="images/logomentorify.png" alt="Mentorify Logo">
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" style="font-size: 120%;">‚û§</a></li>
                <li><a href="#" style="font-size: 120%;">üè†Ô∏é</a></li>
                <li><a href="#" style="font-size: 150%;">üå£</a></li>
            </ul>
        </div>

        <!-- Main Chat Content -->
        <div class="chat-content">
            <div class="chat-messages" id="chatMessages"></div>
            <form class="chat-input" id="chatForm">
                <a class="chat-input-icon1">+</a>
                <input type="text" autocomplete="off" id="prompt" placeholder="Message Mentorify" />
                <button type="submit" class="chat-input-icon2">‚û§</button>
            </form>
        </div>
    </div>

    <script>
        let eventSource;
        const chatMessages = document.getElementById("chatMessages");

        function appendMessage(content, type = "bot") {
            let lastMessage = chatMessages.lastElementChild;
            if (!lastMessage || lastMessage.className !== `chat-message ${type}`) {
                lastMessage = document.createElement("div");
                lastMessage.className = `chat-message ${type}`;
                chatMessages.appendChild(lastMessage);
            }
            lastMessage.innerHTML += content.replace(/\n/g, "<br>"); // Use innerHTML to allow <br> tags
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function startEventSource(message) {
            if (eventSource) {
                eventSource.close(); // Close any existing connection
            }

            eventSource = new EventSource(`http://127.0.0.1:5000/stream_chat?message=${encodeURIComponent(message)}`);
            // appendMessage("Mentorify is typing...\n", "bot");

            eventSource.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.error) {
                        appendMessage(`Error: ${data.error}`, "error-message");
                        eventSource.close();
                    } else if (data.message) {
                        appendMessage(data.message.replace(/\\n/g, "<br>"), "bot"); // Replace newline escape sequences with <br>
                    }
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                    appendMessage("Error processing response from Mentorify. Please try again.", "error-message");
                    eventSource.close();
                }
            };

            eventSource.onerror = function (e) {
                console.error("EventSource encountered an error:", e);
                eventSource.close();
            };
        }

        document.getElementById("chatForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const messageInput = document.getElementById("prompt");
            const messageText = messageInput.value.trim();

            if (messageText) {
                appendMessage(messageText, "user");
                messageInput.value = ""; // Clear input
                startEventSource(messageText);
            }
        });


    </script>
</body>
</html>
